<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ุงูุชุญุงู ุงููุบุฉ ุงูุนุฑุจูุฉ (ูุธุงู ุงูุชุงุจูุช) - ูุฑุงูุจ ๐</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --primary: #0f766e;
            --primary-dark: #115e59;
            --accent: #f59e0b;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --selected: #e0f2fe;
            --selected-border: #0ea5e9;
            --correct-bg: #dcfce7;
            --correct-border: #22c55e;
            --wrong-bg: #fee2e2;
            --wrong-border: #ef4444;
            --flag-color: #ef4444;
            --flag-bg: #fef2f2;
        }

        body.dark-mode {
            --primary: #2dd4bf;
            --primary-dark: #14b8a6;
            --accent: #fbbf24;
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
            --selected: #172554;
            --selected-border: #38bdf8;
            --correct-bg: #064e3b;
            --correct-border: #34d399;
            --wrong-bg: #7f1d1d;
            --wrong-border: #f87171;
            --flag-color: #f87171;
            --flag-bg: #450a0a;
        }

        * { box-sizing: border-box; transition: all 0.2s ease; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 16px;
        }

        /* Progress Line */
        .progress-line { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: var(--border); z-index: 2000; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        /* Sidebar */
        .sidebar {
            width: 260px; background: var(--bg-card); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 15px; z-index: 1000;
            box-shadow: 2px 0 15px rgba(0,0,0,0.05);
        }

        .brand { font-size: 1.1rem; font-weight: 800; color: var(--primary); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .nav-items { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .nav-btn {
            background: transparent; border: 1px solid transparent; padding: 10px; border-radius: 6px;
            text-align: right; cursor: pointer; font-weight: 600; color: var(--text-main); font-size: 0.9rem;
            display: flex; justify-content: space-between;
        }
        .nav-btn:hover { background: var(--bg-body); }
        .nav-btn.active { background: var(--selected); color: var(--primary-dark); border-color: var(--selected-border); }
        
        /* Font Controls */
        .controls-row { display: flex; gap: 5px; margin-bottom: 10px; justify-content: center; }
        .icon-btn {
            background: var(--bg-body); border: 1px solid var(--border); width: 32px; height: 32px;
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-main); font-size: 0.9rem;
        }
        .icon-btn:hover { border-color: var(--primary); color: var(--primary); }

        /* Main Area */
        .main-content { flex: 1; overflow-y: auto; padding: 20px 40px; position: relative; scroll-behavior: smooth; }

        .section-header { margin: 30px 0 20px; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }

        .passage-card {
            background: var(--bg-card); border-radius: 8px; padding: 25px; margin-bottom: 25px;
            border-right: 4px solid var(--primary); line-height: 2.2; font-size: 1.1em; text-align: justify;
        }
        
        .q-card {
            background: var(--bg-card); border-radius: 10px; padding: 20px; margin-bottom: 20px;
            border: 1px solid var(--border); position: relative; transition: all 0.3s ease;
        }

        /* Flag Button Styling */
        .flag-toggle {
            position: absolute; top: 15px; left: 15px; background: transparent; border: none;
            color: var(--text-light); cursor: pointer; font-size: 1.4rem; z-index: 2;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0.5;
        }
        .flag-toggle:hover { opacity: 1; transform: scale(1.1); }
        
        /* Active Flag State (Button) */
        .flag-toggle.active {
            color: var(--flag-color);
            opacity: 1;
            transform: scale(1.2);
            filter: drop-shadow(0 2px 4px rgba(239, 68, 68, 0.3));
        }

        /* Active Flag State (Card) */
        .q-card.flagged-card {
            border-color: var(--flag-color);
            background-color: var(--flag-bg);
            box-shadow: 0 0 0 1px var(--flag-color), 0 4px 12px rgba(0,0,0,0.05);
        }

        .q-text { font-size: 1.15rem; font-weight: 700; margin: 10px 0 20px; padding-left: 35px; line-height: 1.6; }

        /* Options */
        .option {
            background: var(--bg-body); padding: 12px 15px; border-radius: 8px; margin-bottom: 10px;
            cursor: pointer; border: 2px solid transparent; display: flex; align-items: center; gap: 12px;
            position: relative; transition: all 0.2s;
        }
        .option:hover { background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .option.selected { background: var(--selected); border-color: var(--selected-border); font-weight: 600; }
        
        /* Strikethrough Logic */
        .option.eliminated { opacity: 0.5; text-decoration: line-through; background: #eee; border-color: transparent !important; }
        .option.eliminated .circle { border-color: #bbb; }
        .strike-btn {
            margin-right: auto; width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--border);
            background: var(--bg-card); display: flex; align-items: center; justify-content: center;
            color: var(--text-light); cursor: pointer; font-size: 0.7rem;
        }
        .strike-btn:hover { color: var(--wrong-border); border-color: var(--wrong-border); }

        .circle {
            width: 18px; height: 18px; border-radius: 50%; border: 2px solid #cbd5e1; flex-shrink: 0;
            display: flex; justify-content: center; align-items: center;
        }
        .option.selected .circle { border-color: var(--primary); background: var(--primary); }
        .option.selected .circle::after { content: 'โ'; color: white; font-size: 10px; }

        /* Review Styles */
        body.review-mode .option { cursor: default; pointer-events: none; }
        body.review-mode .option.correct-ans { background: var(--correct-bg) !important; border-color: var(--correct-border) !important; }
        body.review-mode .option.wrong-ans { background: var(--wrong-bg) !important; border-color: var(--wrong-border) !important; }

        /* Footer */
        .footer-tools {
            margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 10px;
        }
        .timer-display {
            background: var(--text-main); color: var(--bg-body); padding: 8px; border-radius: 6px;
            text-align: center; font-weight: 800; font-size: 1.2rem; letter-spacing: 2px;
        }
        .grid-btn {
            background: var(--bg-body); border: 1px dashed var(--primary); color: var(--primary);
            padding: 8px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%;
        }
        .submit-btn {
            background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px;
            cursor: pointer; font-weight: bold; width: 100%; font-size: 1rem;
        }

        /* Question Map Modal */
        .sheet-modal {
            position: fixed; bottom: -100%; left: 0; width: 100%; height: 70vh; background: var(--bg-card);
            z-index: 3000; border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .sheet-modal.open { bottom: 0; }
        .sheet-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sheet-grid { flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px; align-content: start; }
        
        .bubble {
            width: 45px; height: 45px; border-radius: 50%; border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer;
            background: var(--bg-body); font-size: 0.9rem;
        }
        .bubble.answered { background: var(--primary); color: white; border-color: var(--primary); }
        .bubble.flagged { background: var(--flag-color); color: white; border-color: var(--flag-color); }

        /* Result Modal */
        .result-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            z-index: 4000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .result-content {
            background: var(--bg-card); width: 90%; max-width: 450px; padding: 30px; border-radius: 15px; text-align: center;
        }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; order: -1; padding: 10px; flex-direction: row; height: auto; align-items: center; border-bottom: 1px solid var(--border); border-left: none; }
            .brand span:last-child, .controls-row, .timer-display { display: none; }
            .nav-items { flex-direction: row; overflow-x: auto; padding-bottom: 5px; }
            .nav-btn { white-space: nowrap; padding: 6px 12px; font-size: 0.8rem; }
            .main-content { padding: 15px; padding-bottom: 100px; }
            .mobile-tools {
                position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card);
                border-top: 1px solid var(--border); padding: 10px; display: flex; gap: 10px; z-index: 2500;
            }
        }

        /* --- Camera and Modal Styles --- */
        #cameraPreview {
            position: fixed; bottom: 20px; left: 20px; width: 160px; height: 120px;
            border-radius: 8px; border: 2px solid #ef4444; z-index: 5000;
            background: #000; overflow: hidden; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #cameraPreview video { width: 100%; height: 100%; object-fit: cover; }
        #recDot {
            position: absolute; top: 5px; right: 5px; width: 10px; height: 10px;
            background: red; border-radius: 50%; animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        #startModalOverlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.98);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .start-box {
            background: white; padding: 30px; border-radius: 12px; max-width: 500px; text-align: center;
        }
        .start-box ul { text-align: right; margin: 20px 0; line-height: 1.8; color: #333; }
        
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 10px 20px; border-radius: 50px;
            z-index: 10000; font-weight: bold; animation: fadeOut 3s forwards;
        }
        @keyframes fadeOut { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body>

<div id="startModalOverlay">
    <div class="start-box">
        <h2 style="color:#ef4444;">โ๏ธ ูุธุงู ุงููุฑุงูุจุฉ ูุงูุจุซ ุงููุจุงุดุฑ (ูุดุฏุฏ)</h2>
        <input type="text" id="studentName" placeholder="ุฃุฏุฎู ุงุณูู ุงูุซูุงุซู" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px; text-align: right;">
        <ul>
            <li>๐น ุงูุงูุชุญุงู ูุฑุงูุจ ุจูุธุงู ุงูุจุซ ุงููุจุงุดุฑ (Live Stream).</li>
            <li>๐ซ ููููุน ุงุณุชุฎุฏุงู ุงููุฃุฑุฉ ุงูุฃููู ุฃู ุฃุฏูุงุช ุงููุทูุฑูู.</li>
            <li>๐ซ ููููุน ุงูุฎุฑูุฌ ูู ูุถุน ููุก ุงูุดุงุดุฉ.</li>
            <li>๐๏ธ ุฃู ูุญุงููุฉ ุบุด ุณุชุคุฏู ุฅูู ุญุธุฑ ุงูุฌูุงุฒ ููุงุฆูุงู.</li>
        </ul>
        <button onclick="initExamSystem()" style="background:#22c55e; color:white; border:none; padding:12px 30px; border-radius:6px; font-weight:bold; cursor:pointer; font-size:1.1rem;">ููุงูู ูุฃุจุฏุฃ ุงูุจุซ ูุงูุงูุชุญุงู</button>
    </div>
</div>

<div id="cameraPreview">
    <div id="recDot"></div>
    <video id="userVideo" autoplay muted playsinline></video>
</div>

<div class="progress-line"><div class="progress-fill" id="progressFill"></div></div>

<aside class="sidebar">
    <div class="brand">
        <span>๐ซ ููุตุฉ ุงูุงุฎุชุจุงุฑ</span>
        <span style="font-size:0.8rem; color:#ef4444;">Live ๐ด</span>
    </div>
    
    <div style="background:#fee2e2; padding:10px; border-radius:6px; text-align:center; margin-bottom:10px; border:1px solid #ef4444;">
        <small style="color:#ef4444; font-weight:bold;">ุงููุฎุงููุงุช: <span id="violationCount">0</span></small>
    </div>

    <div class="controls-row">
        <button class="icon-btn" onclick="changeFontSize(1)">A+</button>
        <button class="icon-btn" onclick="changeFontSize(-1)">A-</button>
        <button class="icon-btn" onclick="toggleTheme()">๐</button>
    </div>

    <div class="nav-items" id="navContainer"></div>

    <div class="footer-tools" id="desktopTools">
        <div class="timer-display" id="timerDisplay">03:00:00</div>
        <button class="grid-btn" onclick="toggleSheet()">๐บ๏ธ ุฎุฑูุทุฉ ุงูุฃุณุฆูุฉ</button>
        <button class="submit-btn" id="submitBtn" onclick="submitExam()">ุชุณููู ุงูุงูุชุญุงู</button>
    </div>
</aside>

<div class="mobile-tools" style="display:none;" id="mobileTools">
    <div style="flex:1; font-weight:bold; align-self:center;" id="mobileTimer">03:00:00</div>
    <button class="icon-btn" onclick="toggleSheet()" style="width:auto; padding:0 15px;">๐บ๏ธ</button>
    <button class="submit-btn" onclick="submitExam()" style="width:auto; padding:0 20px;">ุชุณููู</button>
</div>

<main class="main-content" id="renderArea"></main>

<div class="sheet-modal" id="sheetModal">
    <div class="sheet-header">
        <h3 style="margin:0;">ุฎุฑูุทุฉ ุงูุฃุณุฆูุฉ</h3>
        <button class="icon-btn" onclick="toggleSheet()">โ</button>
    </div>
    <div class="sheet-grid" id="sheetGrid"></div>
</div>

<div class="result-modal" id="resultModal">
    <div class="result-content">
        <h2 style="color:var(--primary); margin:0 0 10px;">ูุชูุฌุฉ ุงูุงูุชุญุงู</h2>
        <div style="font-size:3.5rem; font-weight:800; color:var(--text-main);" id="scoreNum">0</div>
        <div style="color:var(--text-light); margin-bottom:20px;">ูู 80 ุฏุฑุฌุฉ</div>
        <div id="feedback" style="background:var(--bg-body); padding:10px; border-radius:8px; margin-bottom:15px; text-align:right;"></div>
        <p style="color:green; font-weight:bold; font-size:0.9rem;">ุชู ุญูุธ ุงูุจุซ ุงููุจุงุดุฑ ูุฑูุน ุงูุชูุฑูุฑ ุจูุฌุงุญ โ</p>
        <button class="submit-btn" onclick="startReview()">๐ ูุฑุงุฌุนุฉ ุงูุฅุฌุงุจุงุช</button>
        <button class="grid-btn" onclick="clearProgress(); location.reload();" style="margin-top:10px; border-style:solid;">๐ ุงูุชุญุงู ุฌุฏูุฏ</button>
    </div>
</div>

<script>
    // --- Data Configuration ---
    const sectionsConfig = [
        { id: 'Read1', title: 'ุฃููุงู: ุงููุฑุงุกุฉ ุงูุนูููุฉ', count: 6 },
        { id: 'Read2', title: 'ุซุงููุงู: ุงููุฑุงุกุฉ ุงูุฃุฏุจูุฉ', count: 6 },
        { id: 'Poetry', title: 'ุซุงูุซุงู: ุงููุตูุต', count: 8 },
        { id: 'Lit', title: 'ุฑุงุจุนุงู: ุงูุฃุฏุจ', count: 5 },
        { id: 'Grammar', title: 'ุฎุงูุณุงู: ุงููุญู', count: 35 },
        { id: 'Expr', title: 'ุณุงุฏุณุงู: ุงูุชุนุจูุฑ', count: 20 }
    ];

    const examData = [
        // === ุฃููุงู: ุงููุฑุงุกุฉ ุงููุชุญุฑุฑุฉ (ุงูููุงู ุงูุนููู) ===
        {
            type: 'passage', section: 'Read1',
            content: `
            <strong>ุฃููุงู: ุงููุฑุงุกุฉ ุงููุชุญุฑุฑุฉ (ุงูููุงู ุงูุนููู)</strong><br><br>
            "ุนุงุฏุฉ ุชูุน ุงูุญุฑูุจ ุจูู ุทุฑูู ูุฒุงุน ูุดูุง ูู ุฅูุฌุงุฏ ูุณุงุญุฉ ููุชูุงูู ูุชุญููู ูุตูุญุฉ ูุดุชุฑูุฉ ุฃู ูู ุฅูุฌุงุฏ ุฃุฑุถูุฉ ููุงุชูุงู ุนูู ุญู ูููุฒุงุนุ ูููุน ุงูุถุญุงูุง ูุชูู ูุฌุฑุญู ูู ุงูุทุฑูููุ ูุชุฏูุฑ ูุฑุงูู ููุณุงููุ ูุชุฎุชูู ูุนุงูู ุงููุฏููุฉุ ููุญู ููุงููุง ูุดุงูุฏ ุงูุฎุฑุงุจ ูุงูุฏูุงุฑ. ูููุน ูุฐุง ููู ูู ูุทุงู ุงูุจูุฆุฉุ ููู ุจุฃุจุนุงุฏูุง ูุณุฑุญ ุงููุฒุงุนุ ูุงููุชุถุฑุฑุฉ ุจุขุซุงุฑู ูุชุจุนุงุชู ุนูู ุงููุฏู ุงููุฑูุจ ูุงูุจุนูุฏ. ูุงูุถุฑุฑ ุงููุงูุน ุนูู ุงูุจูุฆุฉ ูู ุฌุฑุงุก ุงูุญุฑูุจ ูุชูุซู ูู ุชูู ุงูุฃูุธูุฉ ุงูุจูุฆูุฉุ ูุงุณุชูุฒุงู ุงูููุงุฑุฏ ุงูุทุจูุนูุฉ ูุบูุฑูุงุ ููุง ูุจูู ุชุฃุซูุฑู ุนูู ุงููุฏู ุงูุจุนูุฏ ุงูุฐู ูุฏ ููุชุฏ ุญูุจูุง ุจุนุฏ ุงูุชูุงุก ุงูุตุฑุงุน.<br><br>
            ููู ุตูุฑ ุงูุฅุถุฑุงุฑ ุจุงูุจูุฆุฉ ูุชูุฌุฉ ุงูุญุฑูุจ: ุชุณููู ุงูููุงู ุงูุฌูููุฉุ ูุงููุถุงุก ุนูู ุงูุญูุงุฉ ุงูุจุฑูุฉุ ูุชูููุซ ููุงู ุงูุฃููุงุฑ ูุงูุจุญุงุฑุ ูุชููุซ ุงูููุงุกุ ูุชุฏููุฑ ุงูุบุงุจุงุช ูุงูุบุทุงุก ุงููุจุงุชู ููุฃุฑุถุ ูุฅุชูุงู ุงููุญุงุตูู ูุงููุฒุฑูุนุงุช ุงูุชู ุชุนุฏ ูุตุฏุฑุงู ููุบุฐุงุก. ููู ุฃูุซูุฉ ูุง ุฃุญุฏุซุชู ุงูุญุฑูุจ ูู ุฏูุงุฑ ุงูุจูุฆุฉ: ูุง ุณุจุจุชู ุงูุญุฑุจ ุงูุฑูุณูุฉ ุงูุฃููุฑุงููุฉ ูู ุฅูุชุงุฌ 100 ููููู ุทู ูู ูุฑูุจุงุช ุงููุฑุจูู ุงูุถุงุฑุฉ ูู ูุฏุฉ ูุง ุชุชุฌุงูุฒ 7 ุฃุดูุฑุ ูุฅุณูุงุท ุงูุฌูุด ุงูุฃูุฑููู ูู ุงูุญุฑุจ ุงูููุชูุงููุฉ ุญูุงูู 200 ุฃูู ุทู ูู ูุจูุฏุงุช ุงูุฃุนุดุงุจ ุนูู ุงูุบุงุจุงุชุ ููุง ูุชุฌ ุนูู ุชุณููู ุงูููุงู ูุชุนุฑูุฉ ูุณุงุญุงุช ูุงุณุนุฉ.<br><br>
            ูุฐูู ุชุฌุฑูู ุงูุงุญุชูุงู ุงูุฅุณุฑุงุฆููู ุงูุฃุฑุงุถู ุงูุฒุฑุงุนูุฉ ุงูููุณุทูููุฉุ ูุงูุชูุงุนู ูุง ููุฑุจ ูู 2.5 ููููู ุดุฌุฑุฉ ูุซูุฑุฉ ูููุง 800 ุฃูู ุดุฌุฑุฉ ุฒูุชูู ููุฐ 1967ูุ ูุถูุงู ุนู ุชูููุซ ุงูููุงุก ุจูุฑูุจุงุช ุงูููุณููุฑ ุงูุณุงูุฉ ุงููุงุชุฌุฉ ุนู ุงูููุงุจู ุงูููุณููุฑูุฉุ ุญูุซ ุชุชุฑุณุจ ูู ุงูุชุฑุจุฉ ูุงูููุงู ููุชุฑุงุช ููุชุฏุฉุ ูุชุณุจุจ ุญุฑููุงู ูุฃูุฑุงุถุงู ููุฃุญูุงุก. ููุฏ ุญุฐุฑุช ุงููุฌูุฉ ุงูุฏูููุฉ ููุตููุจ ุงูุฃุญูุฑ ุจุฃู ุชุบูุฑ ุงูููุงุฎ ูู ุนูุงูุจ ูุฏูุฑุฉ ุนูู ุงูุฃุดุฎุงุต ุงูุฐูู ูุนูุดูู ูู ููุงุทู ุงูุตุฑุงุน."
            `
        },
        { section: 'Read1', q: 'ุจูู ูุฏุฑ ุงููุงุชุจ ุนุฏุฏ ุฃุดุฌุงุฑ ุงูุฒูุชูู ุงูุชู ุฌุฑููุง ุงูุงุญุชูุงู ูู ููุณุทูู ููุฐ 1967ูุ', options: ['2.5 ููููู', '800 ุฃูู', '200 ุฃูู', '100 ููููู'], a: 1 },
        { section: 'Read1', q: 'ูุงุฐุง ุฃูุงุฏุช ุนุจุงุฑุฉ "ูู ููุธูุฑ ุจูุฆู" ูู ุจุฏุงูุฉ ุงูููุถูุน (ููุง ูููู ูู ุงูุณูุงู)ุ', options: ['ุฃู ุชุฑููุฒ ุงููุงุชุจ ุนูู ุงูุฎุณุงุฆุฑ ุงูุจุดุฑูุฉ', 'ุฃู ุชุฑููุฒ ุงููุงุชุจ ุนูู ุงูุฎุณุงุฆุฑ ุงูุงูุชุตุงุฏูุฉ', 'ุฃู ุงููุถูุฉ ูุชู ุชูุงูููุง ูู ุฒุงููุฉ ุชุฃุซูุฑูุง ุนูู ุงูุทุจูุนุฉ ูุงูููุงุฎ', 'ุฃู ุงูููุงู ุณูุงุณู ุจุญุช'], a: 2 },
        { section: 'Read1', q: 'ุงุณุชูุชุฌ ุนูุงูุฉ ุฌููุฉ "ููู ุจุฃุจุนุงุฏูุง ูุณุฑุญ ุงููุฒุงุน" ุจูุง ูุจููุง:', options: ['ุชุนููู', 'ูุชูุฌุฉ', 'ุชูุตูู', 'ุงุณุชุฏุฑุงู'], a: 0 },
        { section: 'Read1', q: 'ูุงุช ูู ุงูููุถูุน ูุง ูุฏู ุนูู ุฅุถุฑุงุฑ ุงูุญุฑูุจ ุจุงูุบุทุงุก ุงููุจุงุชู:', options: ['ุฅูุชุงุฌ ูุฑูุจุงุช ุงููุฑุจูู', 'ุฅุณูุงุท ูุจูุฏุงุช ุงูุฃุนุดุงุจ ูุชุฌุฑูู ุงูุฃุดุฌุงุฑ', 'ุงุณุชุฎุฏุงู ุงูููุงุจู ุงูููุณููุฑูุฉ', 'ุชุณููู ุงูููุงู ุงูุฌูููุฉ'], a: 1 },
        { section: 'Read1', q: 'ุงูููุฑุฉ ุงูุฑุฆูุณุฉ ููููุฑุฉ ุงูุซุงููุฉ ูู:', options: ['ุชุนุฑูู ุงูุญุฑูุจ', 'ุตูุฑ ูุฃูุซูุฉ ูุงูุนูุฉ ูุชุฏููุฑ ุงูุจูุฆุฉ ูู ุงูุญุฑูุจ', 'ุงูููุงููู ุงูุฏูููุฉ', 'ุฃููุงุน ุงูุฃุณูุญุฉ'], a: 1 },
        { section: 'Read1', q: 'ูุง ุงูููุตูุฏ ุจู "ุงูุขุซุงุฑ ุงูููุชุฏุฉ ุญูุจูุง" ูู ุงูููุฑุฉ ุงูุฃูููุ', options: ['ุฃู ุงูุญุฑุจ ุทูููุฉ ุงูุฃูุฏ', 'ุฃู ุงูุชููุซ ูุจูู ุชุฃุซูุฑู ูุฃุฌูุงู ูุงุฏูุฉ', 'ุฃู ุงูุชุงุฑูุฎ ูุนูุฏ ููุณู', 'ุฃู ุงูุฏูู ุชุชุตุงูุญ ุจุตุนูุจุฉ'], a: 1 },

        // --- ุซุงููุงู: ุงููุฑุงุกุฉ ุงููุชุญุฑุฑุฉ (ุฃุญูุฏ ุฃููู) ---
        {
            type: 'passage', section: 'Read2',
            content: `
            <strong>ุซุงููุงู: ุงููุฑุงุกุฉ ุงููุชุญุฑุฑุฉ (ุงูููุงู ุงูุฃุฏุจู - ุฃุญูุฏ ุฃููู)</strong><br><br>
            "ุฃู ุจููุ ุฅูู ุงูุขู ุชุฏุฑุณ ูู ุฃูุฑูุจุง ุจุนุฏ ุฃู ุฃุชููุช ุฏุฑุงุณุชู ูู ูุตุฑุ ูุงูุฐูู ุฏุฑุณูุง ูุจูู ูู ุฃูุฑูุจุง ุฃุดูุงู ูุฃููุงูุ ุงุฎุชููุช ููุงุฒุนูู ูุงุฎุชููุช ุงุชุฌุงูุงุชููุ ูุงุฎุชูููุง ูู ููุฏุงุฑ ูุฌุงุญูู ููุดููู. ููููู ูู ุดุนุฑ ุจุฃู ุญุฑูุชู ูู ูุตุฑ ูุงูุช ููููุฏุฉุ ูุฑุขูุง ูู ุฃูุฑูุจุง ููููุฑุฉุ ููุฏ ุชุญุฑุฑ ูู ุฑูุงุจุฉ ุฃุจููู ููุฏุฑุณุชูุ ูุฃุตุจุญ (ุฃููุฑ ููุณู)ุ ููู ูููู ููููู ุฃุจุงู ุฃูู ูุฌุฏุ ููุญุชุงู ุนููู ูู ุชุญุตูู ุงููุงู ุจูู ูุณููุฉ... ูุฃุฎูุฑุงู ุชููุดู ุงูุฃููุฑ ุนู ูุฃุณุงุฉ ููุนูุฏ ุฅูู ุจูุฏู ููุง ุนูู ูู ููุง ุฎูู.<br><br>
            ููู ุงูุฏุงุฑุณูู ูู ุฃูุฑูุจุง ูู ุนูููุง ุนูู ุฏุฑูุณูู ุจูู ุฌุฏุ ููู ูุนุฑููุง ุบูุฑ ุญุฌุฑุชูู ููุชุจูู ูุฌุงูุนุชูู... ูุฏ ููููุง ุญุฌุฑุชูู ูู ูุตุฑ ุฅูู ุญุฌุฑุฉ ูู ุฅูุฌูุชุฑุง ุฃู ูุฑูุณุง... ูุคูุงุก ูุฏ ููุช ุนููููู ูุบุฒุฑ ุนููููุ ูููููู ูู ุชุชูุชุญ ูููุจูู ููู ุชุฑู ูููุณูู.<br><br>
            ูููุงู ุทุงุฆูุฉ ุซุงูุซุฉ ูู ุงูุชู ุชุนุฌุจูู ููู ุงูุชู ุฃุญุจ ุฃู ุชุณูุฑ ุนูู ููุฌูุง: ูุคูุงุก ูุฏ ููููุง ุฑุณุงูุชูู ูู ุจุนุซุชูู ุนูู ุงููุฌู ุงูุฃูููุ ููููุง ุฃููู ุฅููุง ุณุงูุฑูุง ููุฏุฑุณูุง ุนููุงูุ ูููุฏุฑุณูุง ุฎููุงู... ูุจุญุซูู ุนู ุณุฑ ุนุธูุฉ ูุฐู ุงูุฃููุ ูููุงุทู ููุชูุง ูุถุนููุง... ูุชุนูููู ูุฐู ุงูุฏุฑูุณ ููุง ุชูุน ุนููู ุงูุนูู ุงูููุชูุญุฉ ูุงูููุจ ุงููุงุนู ูู ุงูุดูุงุฑุน ูุงูุญุฏุงุฆู."
            `
        },
        { section: 'Read2', q: 'ุจูู ูุตู ุงููุงุชุจ ุงูุทุงุฆูุฉ ุงูุฃููู ูู ุงูุฏุงุฑุณููุ', options: ['ุจุงูุฌุฏูุฉ ุงูููุฑุทุฉ', 'ุจุงูุงุญุชูุงู ูุงูุงูุบูุงุณ ูู ุงูุดููุงุช', 'ุจุงูุงูุนุฒุงู ุงูุชุงู', 'ุจุงูุชูุงุฒู ุงูููุณู'], a: 1 },
        { section: 'Read2', q: 'ูุง ุฏูุงูุฉ ููู ุงููุงุชุจ "ููููุง ุญุฌุฑุชูู ูู ูุตุฑ ุฅูู ุญุฌุฑุฉ ูู ุฅูุฌูุชุฑุง"ุ', options: ['ุญุจูู ูููุธุงู', 'ุงูุญูุงุธ ุนูู ุงูุฃุซุงุซ', 'ุงูุงูุนุฒุงู ูุนุฏู ุงูุงุฎุชูุงุท ุจุซูุงูุฉ ุงูุจูุฏ ุงููุถูู', 'ุงูููุฑ ูุถูู ุงูุญุงู'], a: 2 },
        { section: 'Read2', q: 'ุงููุณูู ุงูุฐู ููุถูู ุงููุงุชุจ ูู:', options: ['ุงูุญุฑูุฉ ุงููุทููุฉ', 'ุงูุนูู ุงูุฃูุงุฏููู ููุท', 'ุงูุฌูุน ุจูู ุงูุนูู ูุฏุฑุงุณุฉ ุงูุญูุงุฉ ูุงููุฌุชูุน', 'ุงูุนูุฏุฉ ุณุฑูุนุงู ูููุทู'], a: 2 },
        { section: 'Read2', q: 'ุนูุงูุฉ "ููุฏ ุชุญุฑุฑ ูู ุฑูุงุจุฉ ุฃุจููู" ุจูุง ูุจููุง:', options: ['ุชุนููู', 'ูุชูุฌุฉ', 'ุชูุถูุญ', 'ุชูุตูู'], a: 0 },
        { section: 'Read2', q: 'ูุง ุงููุบุฒู ูู ูููู "ุฃุตุจุญ ุฃููุฑ ููุณู"ุ', options: ['ุชููู ููุตุจุงู', 'ุฃุตุจุญ ูุณุคููุงู', 'ุตุงุฑ ูุชุตุฑู ุจููุงู ุฏูู ุฑููุจ', 'ุฃุตุจุญ ุบููุงู'], a: 2 },
        { section: 'Read2', q: 'ุงุณุชูุชุฌ ูู ุงููุต ุณูุฉ ูู ุณูุงุช ุฃุณููุจ ุฃุญูุฏ ุฃููู:', options: ['ุงุณุชุฎุฏุงู ุงูุณุฌุน ุงููุชููู', 'ุณูููุฉ ุงูุฃููุงุธ ููุถูุญ ุงูููุฑุฉ ูุงูุชูุณูู ุงูููุทูู', 'ุงูุบููุถ ูุงูุฑูุฒูุฉ', 'ุงุณุชุฎุฏุงู ุงูุนุงููุฉ'], a: 1 },

        // --- ุซุงูุซุงู: ุงููุตูุต ุงูุดุนุฑูุฉ ---
        {
            type: 'passage', section: 'Poetry',
            content: `
            <strong>ุซุงูุซุงู: ุงููุตูุต ุงูุดุนุฑูุฉ (ูุฏุฑุณุฉ ุฃุจููู - ุตุงูุญ ุงูุดุฑููุจู)</strong><br><br>
            1. ูููููุชู ุนููุฑู ุนููู ููููู ููุขูุงูู ... ููุจูุนุชูููู ูููููุชู ููุงูููุทููุญู ุงูุบุงูู<br>
            2. ุฃูุญูุง ููููู ููุฃููุฏู ููุฌุฏูููู ูููููุงู ... ุจูุงูุนุงูููููู ุฌููุงุฏุงู ุบููุฑู ุจูุฎูุงูู<br>
            3. ููุฑูุญุชู ุฃูุดุฏู ููููููู ุงููููุจู ููุงูุจุงูู ... ุฃูููููุชู ูู ุงููุงุฑู ุฃูููุงุณู ููุฃููุตุงูู<br>
            4. ุฅูู ุถุงุญูููุง ุฏููุฑูููู ุจุงุฑููุชูููู ููุฑูุญุงู ... ููุฅูู ุชููุงุฏูุง ุฅููู ููููู ููุคูุฑููููููู<br>
            5. ููููู ููููู ุฒูููุฉู ุงูุฏูููุง ููุจููุฌูุชููุง ... ูููู ุณููุงุกู ุงูููุนุงูู ููุฌูููุง ุงูุนุงูู<br>
            6. ุฃูููู ูููุงููู ููุฃููุฏู ููููููู ุดูููุจุงู ... ููุดูุฏููู ุงูุนููุง ุจูุงูุนูููู ููุงููุงูู
            `
        },
        { section: 'Poetry', q: 'ุจูู ูุตู ุงูุดุงุนุฑ ููุณู ูู ุงูุจูุช ุงูุฃููุ', options: ['ุจุงูุชุฑุฏุฏ', 'ุจุงูุชูุงูู ูููุจ ุญูุงุชู ูููุชู ููููู', 'ุจุงูุทูุน ูู ุงูููุงุตุจ', 'ุจุงูุฑุบุจุฉ ูู ุงูุณูุฑ'], a: 1 },
        { section: 'Poetry', q: 'ุงูููุตูุฏ ุจู "ูุดูุฏูู ุงูุนูุง ุจุงูุนูู ูุงููุงู":', options: ['ุฃู ุงููุงู ุฃูู ูู ุงูุนูู', 'ุฃู ุงููุฌุฏ ูุจูู ุจุชูุงูู ุงูุนูู ูุงูุฅููุงู', 'ุฃููู ุฃุบููุงุก ููุท', 'ุฃููู ุนููุงุก ููุฑุงุก'], a: 1 },
        { section: 'Poetry', q: 'ุงูููู ุงูุจูุงูู ูู "ุจุนุชูู ููุชู":', options: ['ุชุดุจูู ุจููุบ', 'ุงุณุชุนุงุฑุฉ ููููุฉ (ุตูุฑ ุงูููุฉ ุจุดูุก ูุงุฏู ูุจุงุน)', 'ูุฌุงุฒ ูุฑุณู', 'ุงุณุชุนุงุฑุฉ ุชุตุฑูุญูุฉ'], a: 1 },
        { section: 'Poetry', q: 'ุงูุนุงุทูุฉ ุงููุณูุทุฑุฉ ุนูู ุงูุดุงุนุฑ:', options: ['ุงูุญุฒู ูุงููุฃุณ', 'ุงููุฎุฑ ูุงูุญุจ ุงูุดุฏูุฏ ูููุทู ููููู', 'ุงูุบุถุจ ูุงูุซูุฑุฉ', 'ุงูุฒูุฏ'], a: 1 },
        { section: 'Poetry', q: 'ุงููุญุณู ุงูุจุฏูุนู ูู ุงูุจูุช ุงูุฃูู (ุขูุงูู - ุงูุบุงูู):', options: ['ุทุจุงู', 'ุชุตุฑูุน', 'ุฌูุงุณ ุชุงู', 'ุญุณู ุชูุณูู'], a: 1 },
        { section: 'Poetry', q: 'ูู ุณูุงุช ูุฏุฑุณุฉ ุฃุจููู ุงููุชุญููุฉ ูู ุงููุต:', options: ['ุงูุญููู ููุฐูุฑูุงุช', 'ุงุณุชุนูุงู ุงููุบุฉ ุงุณุชุนูุงูุงู ุฌุฏูุฏุงู', 'ุฐุงุชูุฉ ุงูุชุฌุฑุจุฉ ุงูููุชุฒุฌุฉ ุจุงูุนุงู', 'ุงูุชุดุงุคู ุงูุดุฏูุฏ'], a: 2 },
        { section: 'Poetry', q: 'ุนูุงูุฉ "ุจุงุฑูุชูู ูุฑุญุงู" ุจูุง ูุจููุง ูู ุงูุจูุช ุงูุฑุงุจุน:', options: ['ุชุนููู', 'ูุชูุฌุฉ', 'ุชูุถูุญ', 'ุชูุตูู'], a: 1 },
        { section: 'Poetry', q: 'ูููุฉ "ูููุงู" ูู ุงูุจูุช ุงูุซุงูู ุชูุญู ุจู:', options: ['ุงูุชุนุจ ูุงููุดูุฉ', 'ุดุฏุฉ ุงูุญุจ ูุงูุชุนูู', 'ุงูุฅุฌุจุงุฑ ูุงูุฅูุฑุงู', 'ุงููุฑุถ'], a: 1 },

        // --- ุฑุงุจุนุงู: ุงูุฃุฏุจ ---
        { section: 'Lit', q: 'ูุงู "ุฃุญูุฏ ูุญุฑู": (ุฃููููู ูููุชููููู ูู ุบููุฑู ุญูููู ... ููููููู ูู ุฏููุงุกู ููููููู ููุฑูุฏู). ููุซู ุงูุจูุช ุฏูุฑ ุฃุญูุฏ ูุญุฑู ูู ุงูุชุทููุฑ:', options: ['ุงูุดุนุฑ ุงููุณุฑุญู', 'ุงูุดุนุฑ ุงูููุญูู ุงูุชุงุฑูุฎู', 'ุดุนุฑ ุงูููุงุณุจุงุช', 'ุดุนุฑ ุงููุตู'], a: 1 },
        { section: 'Lit', q: 'ูู ูุขุฎุฐ "ุงูุฏููุงู" ุนูู "ุงูุฅุญูุงุฆููู":', options: ['ุบูุจุฉ ุงูุฐูููุฉ', 'ุงูุงูุชูุงู ุจูุดูุฑ ุงูุฃุดูุงุก ูุนุฏู ูุถูุญ ุงูุดุฎุตูุฉ', 'ุงููุญุฏุฉ ุงูุนุถููุฉ', 'ุงุณุชุฎุฏุงู ุงูุฑูุฒ'], a: 1 },
        { section: 'Lit', q: 'ูุฏุฑุณุฉ "ุฃุจููู" ุงุชุฎุฐุช ุงุณููุง ุฏูููุงู ุนูู:', options: ['ุงูุชุฃุซุฑ ุจุงูุซูุงูุฉ ุงูุนุฑุจูุฉ', 'ุงูุชุฃุซุฑ ุจุงูุซูุงูุฉ ุงููููุงููุฉ ูุญุจ ุงูุทุจูุนุฉ', 'ุงูุชุฃุซุฑ ุจุงูุซูุงูุฉ ุงููุฑูุณูุฉ', 'ุงูุชูุณู ุจุงููุฏูู'], a: 1 },
        { section: 'Lit', q: 'ูู ุณูุงุช ุงูุชุฌุฏูุฏ ุนูุฏ ุชูุงููุฐ ุงูุจุงุฑูุฏู:', options: ['ุงูุชุฎูู ุงูุชุงู ุนู ุงููุฏูู', 'ุงูุงุฑุชุจุงุท ุจุงูุตุญุงูุฉ ูุณูููุฉ ุงูุฃุณููุจ', 'ุงูุงุนุชูุงุฏ ุนูู ุงูุฑูุฒ ููุท', 'ุงุณุชุฎุฏุงู ุงููุบุฉ ุงูุนุงููุฉ'], a: 1 },
        { section: 'Lit', q: '"ุงูุฎููู ูุทุฑุงู" ูู ุงูุฃุจ ุงูุฑูุญู ูู:', options: ['ุงูููุงุณูููุฉ', 'ุงูุฑููุงูุชูููุฉ (ุงูุงุชุฌุงู ุงููุฌุฏุงูู)', 'ุงููุงูุนูุฉ', 'ุงูููุฌุฑ ููุท'], a: 1 },

        // --- ุฎุงูุณุงู: ุงููุญู (35 ุณุคุงู) ---
        { section: 'Grammar', q: '(ูุง ุถุงุน ูุนุฑูู ููุงูุฆู ุงูุดูุฑ). ุงููุญู ุงูุฅุนุฑุงุจู ูุฌููุฉ (ููุงูุฆู ุงูุดูุฑ):', options: ['ูุนุช (ููููุฉ ูุนุฑูู)', 'ุฎุจุฑ', 'ุญุงู', 'ูุถุงู ุฅููู'], a: 0 },
        { section: 'Grammar', q: '(ูู ูุง ูุบูุถ ุนููู ุนู ุตุฏููู ... ููุช ููู ุนุงุชุจ). ุงููุนู ุงููุงุฒู ูู ุงูุฌููุฉ:', options: ['ูุบูุถ', 'ููุช', 'ูููู', 'ูุฑุถู'], a: 1 },
        { section: 'Grammar', q: '(ููุฑุจูุง ุฎุฒู ุงูุญููู ูุณุงูู .. ุญุฐุฑ ุงูุฌูุงุจ). ุฅุนุฑุงุจ "ุญุฐุฑ":', options: ['ุญุงู', 'ุชูููุฒ', 'ููุนูู ูุฃุฌูู', 'ููุนูู ุจู'], a: 2 },
        { section: 'Grammar', q: '(ุฅูุงู ุนุฒุฉ ุงูุบุถุจ). ุฅุนุฑุงุจ "ุนุฒุฉ":', options: ['ุฎุจุฑ', 'ูุจุชุฏุฃ', 'ููุนูู ุจู ุซุงูู', 'ููุนูู ุจู (ููุนู ูุญุฐูู ุชูุฏูุฑู ุงุญุฐุฑ)'], a: 3 },
        { section: 'Grammar', q: '(ูููุณ ุฃุฎูู ุงูุฏุงุฆู ุงูุนูุฏ ุจุงูุฐู ููููู). ุฎุจุฑ ููุณ:', options: ['ุฃุฎูู', 'ุงูุฏุงุฆู', 'ุจุงูุฐู (ููุฑุฏ ูุฌุฑูุฑ ููุธุงู)', 'ููููู'], a: 2 },
        { section: 'Grammar', q: '(ูุง ุชุญูุฏ ุงูุฑุฃ ุญุชู ุชุฌุฑุจู). ุญูู ุชูููุฏ ุงููุนู "ุชุญูุฏ" ุจุงูููู:', options: ['ูุงุฌุจ', 'ุฌุงุฆุฒ (ูุฃูู ููู)', 'ููุชูุน', 'ูููู'], a: 1 },
        { section: 'Grammar', q: '(ุฃูู ูุง ูุฌุจ ูุญู ุงูููุนู ... ุฃูุง ูุชูุตู ุจูุนูุชู ุฅูู ูุนุตูุชู). ุงูููุถู ูู:', options: ['ุฃูู', 'ูุง ูุฌุจ', 'ุฃูุง ูุชูุตู', 'ุงูููุนู'], a: 2 },
        { section: 'Grammar', q: '(ุดูุฑุงู ููุนุดุฑ ูุงููุง ุจูุณุงุนู ุญููุฏุฉ). ุงูููููุน ูู ุงูุตุฑู ุงููุฌุฑูุฑ ุจุงููุชุญุฉ:', options: ['ูุนุดุฑ', 'ูุณุงุนู (ูุฌุฑูุฑ ุจูุชุญุฉ ููุฏุฑุฉ)', 'ุญููุฏุฉ', 'ุดูุฑุงู'], a: 1 },
        { section: 'Grammar', q: 'ุงููุตุฏุฑ ุงููููู ูู ุฌููุฉ (ูููู ุงูุณูุงุฑุงุช ูุฒุฏุญู - ุณุนู ุงูุญุฌุงุฌ ูุณุนูู ูุฑููุงู):', options: ['ูููู', 'ูุฒุฏุญู', 'ูุณุนูู', 'ุงูุณูุงุฑุงุช'], a: 2 },
        { section: 'Grammar', q: 'ุนูุฏ ูุถุน (ูุง ุงููุงููุฉ ููุฌูุณ) ููุงู (ููุณ) ูู: "ููุณ ุฐูู ุงูููู ููุตุฑูู":', options: ['ูุง ุฐูู ููู ููุตุฑูู', 'ูุง ุฐูู ููู ููุตุฑูู', 'ูุง ุฐูู ููู ููุตุฑูู', 'ูุง ุฐุง ููุฉ ููุตุฑ'], a: 2 },
        { section: 'Grammar', q: 'ุงูุชุฑููุจ ุงูุตุญูุญ ูุญููุงู ูู (ุฅู):', options: ['ุฅู ูู ุงูุชูุงุถุน ุฑูุนุฉู', 'ุฅู ูู ุงูุชูุงุถุน ุฑูุนุฉู', 'ุฅู ุฑูุนุฉู ูู ุงูุชูุงุถุน', 'ุฅู ุฑูุนุฉู ูู ุงูุชูุงุถุน'], a: 0 },
        { section: 'Grammar', q: 'ุงูุฌููุฉ ุงูุชู ุชุญุชูู ุนูู ููุนูู ูุนู:', options: ['ูุฐุงูุฑ ุงูุทุงูุจ ูุถูุก ุงููุตุจุงุญ', 'ูุฐุงูุฑ ุงูุทุงูุจ ูุงููุตุจุงุญ ูุถูุก', 'ูุฐุงูุฑ ุงูุทุงูุจ ูุฒูููู', 'ุงููุตุจุงุญ ูุถูุก ูุงูุทุงูุจ ูุฐุงูุฑ'], a: 0 },
        { section: 'Grammar', q: '(ูู ุนุงููู ุฎุฏู ูุทูู). ุนูุฏ ุชุญููู ูู ุฅูู ุงุณุชููุงููุฉ:', options: ['ูู ุนุงููู', 'ูู ุนุงููุงู', 'ูู ูู ุนุงูู', 'ูู ุนูุงูู'], a: 1 },
        { section: 'Grammar', q: '(ููู ุจุงููู ููููุงู). ุฅุนุฑุงุจ ููุธ ุงูุฌูุงูุฉ:', options: ['ูุงุนู ูุฑููุน ุจุงูุถูุฉ ุงูููุฏุฑุฉ', 'ููุนูู ุจู', 'ุงุณู ูุฌุฑูุฑ', 'ูุงุนู ูุฌุฑูุฑ ููุธุงู ูุฑููุน ูุญูุงู'], a: 3 },
        { section: 'Grammar', q: '(ูุชู ุชุณุนู ูู ุงูุฎูุฑ .... ุฑุถุง ุงููู). ุฃููู:', options: ['ุชูู', 'ูุชูู', 'ูุณูู ุชูู', 'ูุณูู ุชูุงู'], a: 3 },
        { section: 'Grammar', q: '(ูุนู ุงููุนูููู ูุฎูุตูู). ุนูุฏ ูุถุน (ุฃูุดู) ููุงู ูุนู:', options: ['ุฃูุดู ุงููุนูููู ุฃู ูุฎูุตูุง', 'ุฃูุดู ุงููุนูููู ูุฎูุตูู', 'ุฃูุดู ุงููุนูููู ุฃู ูุฎูุตูุง', 'ุฃูุดู ุงููุนูููู ูุฎูุตูู'], a: 2 },
        { section: 'Grammar', q: '(ุฌูุณ ุงูุทุงูุจ ููุชุจูุงู - ุฌูุณ ุงูุทุงูุจ ุงูุชุจุงูุงู). ุฅุนุฑุงุจ ูุง ุจูู ุงูููุณูู:', options: ['ุญุงู ุ ููุนูู ูุฃุฌูู', 'ุญุงู ุ ููุนูู ูุทูู', 'ุชูููุฒ ุ ููุนูู ูุทูู', 'ููุนูู ุจู ุ ุญุงู'], a: 0 },
        { section: 'Grammar', q: 'ููุดู ุนู ูููุฉ (ุงุณุชูุงูุฉ) ูู:', options: ['ููู', 'ููู', 'ููู', 'ุณูู'], a: 1 },
        { section: 'Grammar', q: '(ุงูุฑุฌุงู ูุฑุฌูู - ุงููุณุงุก ูุฑุฌูู). ูุฒู ุงููุนููู:', options: ['ููุนูู ุ ููุนูู', 'ููุนููู ุ ููุนูู', 'ููุนูู ุ ููุนูู', 'ููุนูู ุ ููุนูู'], a: 0 },
        { section: 'Grammar', q: 'ุงุณู ุงูููุนูู ูู ุงููุนู (ุจุงุน):', options: ['ูุจููุน', 'ููุจุงุน', 'ูุจูุน', 'ุจุงุฆุน'], a: 2 },
        { section: 'Grammar', q: '(ุฃุนุธู ุจุงูุตุฏู). ุฅุนุฑุงุจ ุงูุตุฏู:', options: ['ููุนูู ุจู', 'ูุงุนู ูุฌุฑูุฑ ููุธุงู ูุฑููุน ูุญูุงู', 'ูุจุชุฏุฃ', 'ุฎุจุฑ'], a: 1 },
        { section: 'Grammar', q: '(ููุชุง ุงูุทุงูุจุชูู ูุชูููุชุงู - ุงูุทุงูุจุชุงู ููุชุงููุง ูุชูููุชุงู). ุฅุนุฑุงุจ ููุชุง:', options: ['ูุจุชุฏุฃ ูุฑููุน ุจุงูุถูุฉ ุงูููุฏุฑุฉ ุ ุชูููุฏ ูุนููู', 'ุชูููุฏ ุ ูุจุชุฏุฃ ุซุงู', 'ูุจุชุฏุฃ ูุฑููุน ุจุงูุฃูู ุ ุชูููุฏ', 'ูุจุชุฏุฃ ุ ุฎุจุฑ'], a: 0 },
        { section: 'Grammar', q: 'ุงุณู ุงููุงุนู ุงูุนุงูู ูููุง ููู:', options: ['ุฌุงุก ุงููุงุถู ุฅูู ุงููุญููุฉ', 'ูุฐุง ุทุงูุจ ูุฌุชูุฏ ุฃูุณ', 'ุงูุญุณุฏ ูุงุฑ ุขููุฉู ุตุงุญุจููุง', 'ุงููููุฏุณ ูุดุฑู ุงููุดุฑูุน'], a: 2 },
        { section: 'Grammar', q: '(ูุฑุฃุช 12 ูุชุงุจ). ุงููุชุงุจุฉ ุงูุตุญูุญุฉ:', options: ['ุงุซูุง ุนุดุฑ ูุชุงุจุงู', 'ุงุซูู ุนุดุฑ ูุชุงุจุงู', 'ุงุซูุชุง ุนุดุฑุฉ ูุชุงุจุงู', 'ุงุซูู ุนุดุฑ ูุชุจ'], a: 1 },
        { section: 'Grammar', q: 'ุงุณู ุงูุชูุถูู ูู ุงููุนู (ูุง ูุฎูู):', options: ['ุงููุตุฑู ุฃุฌุฏุฑ ุฃูุง ูุฎูู', 'ุงููุตุฑู ุฃุฎูู ูู ุบูุฑู', 'ุงููุตุฑู ูุง ูุฎูู ุฃุจุฏุงู', 'ูุง ูุตุงุบ'], a: 0 },
        { section: 'Grammar', q: '(ุญุถุฑ ุงูุทูุงุจ ุฎูุง ุทุงูุจุงู). ุฅุนุฑุงุจ ุทุงูุจุงู:', options: ['ุงุณู ูุฌุฑูุฑ ููุท', 'ููุนูู ุจู ููุท', 'ุฌุงุฆุฒ ุงูุฌุฑ ูุงููุตุจ', 'ูุงุนู'], a: 2 },
        { section: 'Grammar', q: '(ูุง ูุตุฑููู ุงุชุญุฏูุง). ููุน ุงูููุงุฏู:', options: ['ููุฑุฉ ููุตูุฏุฉ', 'ููุฑุฉ ุบูุฑ ููุตูุฏุฉ', 'ูุถุงู', 'ุดุจูู ุจุงููุถุงู'], a: 0 },
        { section: 'Grammar', q: '(ุฅู ูู ุงูุชุฃูู ุงูุณูุงูุฉ). ุญูู ุชูุฏูู ุงูุฎุจุฑ:', options: ['ูุงุฌุจ', 'ุฌุงุฆุฒ', 'ููุชูุน', 'ูููู'], a: 0 },
        { section: 'Grammar', q: '(ูุงููู ูุฃุฐุงูุฑู). ุญูู ุชูููุฏ ุงููุนู ุจุงูููู:', options: ['ูุงุฌุจ', 'ุฌุงุฆุฒ', 'ููุชูุน', 'ูููู'], a: 0 },
        { section: 'Grammar', q: '(ูุง ูุงู ุงููุคูู ูููุฐุจ). ููุน ุงููุงู:', options: ['ูุงู ุงูุชุนููู', 'ูุงู ุงูุฌุญูุฏ', 'ูุงู ุงูุฃูุฑ', 'ูุงู ุงููุณู'], a: 1 },
        { section: 'Grammar', q: '(ูู ูุชูู ุงููู ูุฌุนู ูู ูุฎุฑุฌุงู). ุนูุงูุฉ ุฌุฒู (ูุชู):', options: ['ุงูุณููู', 'ุญุฐู ุงูููู', 'ุญุฐู ุญุฑู ุงูุนูุฉ', 'ุงูุถูุฉ'], a: 2 },
        { section: 'Grammar', q: '(ุฅููุง ุงููุคูููู ุฅุฎูุฉ). ุนูุฏ ุญุฐู (ูุง) ุชุตุจุญ:', options: ['ุฅู ุงููุคูููู ุฅุฎูุฉ', 'ุฅู ุงููุคูููู ุฅุฎูุฉ', 'ุฅู ุงููุคูููู ุฃุฎูุงุช', 'ุฃู ุงููุคูููู ุฅุฎูุฉ'], a: 1 },
        { section: 'Grammar', q: '(ูุง ุทุงูุจ ุนูู ูุณูู). ููุน ุงุณู ูุง:', options: ['ููุฑุฏ', 'ูุถุงู', 'ุดุจูู ุจุงููุถุงู', 'ุนูู'], a: 1 },
        { section: 'Grammar', q: '(ุงูุนุฏู ูุงุถู ุจู ุงููู). ูุงุถู ุงุณู ููููุต ุญุฐูุช ูุงุคู ูุฃูู:', options: ['ููุฑุฉ ูุฑููุนุฉ', 'ููุฑุฉ ูุฌุฑูุฑุฉ', 'ููุฑุฉ ููุตูุจุฉ', 'ูุนุฑูุฉ'], a: 0 },
        { section: 'Grammar', q: 'ุงููููุฉ ุงูุชู ููุฒุชูุง ููุฒุฉ ูุทุน:', options: ['ุงุณุชุฎุฑุงุฌ', 'ุงูุชุตุงุฑ', 'ุฅูุฑุงู', 'ุงุจู'], a: 2 },

        // --- ุณุงุฏุณุงู: ุงูุชุนุจูุฑ (20 ุณุคุงู) ---
        { section: 'Expr', q: 'ุงูุชุฑุชูุจ ุงูููุทูู ูููุฑุงุช ููุงู ุนู "ุงูุชููุฑ" (ุงููููุฐุฌ: ุธุงูุฑุฉ - ุฃุณุจุงุจ - ุนูุงุฌ):', options: ['ุชุนุฑูู ุงูุชููุฑ > ุฃุณุจุงุจู > ุนูุงุฌู', 'ุนูุงุฌ ุงูุชููุฑ > ุฃุณุจุงุจู > ุชุนุฑููู', 'ูุตุต ุนู ุงูุชููุฑ ููุท', 'ุนูุงุฌ > ุชุนุฑูู > ุฃุณุจุงุจ'], a: 0 },
        { section: 'Expr', q: 'ุนูุงูุฉ ุงูุชุฑููู ุงูููุงุณุจุฉ ููุงู ุงูููุท: (ูุง ุฃุฌูู ุงูุตุฏู ...)', options: ['ุ', '.', '!', 'ุ'], a: 2 },
        { section: 'Expr', q: 'ุงููููุฉ ุงูููุชูุจุฉ ุฎุทุฃ ุฅููุงุฆูุงู:', options: ['ูุคูุค', 'ุชูุงูุค', 'ูุชุจุงุทุก (ุงูุตูุงุจ: ูุชุจุงุทุฆ)', 'ูุงุฑุฆ'], a: 2 },
        { section: 'Expr', q: 'ุนูุฏ ูุชุงุจุฉ "ุชูุฑูุฑ" ูุฌุจ ูุฑุงุนุงุฉ:', options: ['ุงูุฎูุงู ูุงูุนุงุทูุฉ', 'ุงูุฏูุฉ ูุงูููุถูุนูุฉ ูุงูุฅูุฌุงุฒ', 'ุงูุณุฌุน ูุงููุญุณูุงุช', 'ุงูุฅุทุงูุฉ'], a: 1 },
        { section: 'Expr', q: 'ุงูุฑุงุจุท ุงูููุงุณุจ: (ุฐุงูุฑุช ุฌูุฏุงู ..... ูุฌุญุช).', options: ['ููู', 'ูุฐูู', 'ูุน ุฐูู', 'ุจูููุง'], a: 1 },
        { section: 'Expr', q: '(ุงูุจุทุงูุฉ ููุจูุฉ ููููุชุฉ). ุงูุชูุตููุฉ ุงูุชู ุชุฏุนู ูุฐุง ุงูุฑุฃู:', options: ['ูุซุฑุฉ ุฃููุงุช ุงููุฑุงุบ ููุนุจ', 'ุงุฑุชูุงุน ูุนุฏูุงุช ุงูุฌุฑููุฉ ูุงูุนูู ุจูู ุงูุดุจุงุจ ุงูุนุงุทู', 'ุฒูุงุฏุฉ ุนุฏุฏ ุงูุณูุงู', 'ุจูุงุก ุงููุตุงูุน'], a: 1 },
        { section: 'Expr', q: 'ุงููุซู ุงูุฏุงู ุนูู "ุงููุฏู":', options: ['ุณุจู ุงูุณูู ุงูุนุฐู', 'ุฑุฌุน ุจุฎูู ุญููู', 'ุงูุตูู ุถูุนุช ุงููุจู', 'ูุฏุงู ุฃููุชุง ูููู ููุฎ'], a: 2 },
        { section: 'Expr', q: 'ูุชุงุจุฉ (ุงุจู) ุงูุตุญูุญุฉ ูู:', options: ['ูุญูุฏ ุงุจู ุนุจุฏ ุงููู', 'ูุญูุฏ ุจู ุนุจุฏ ุงููู', 'ูุง ุงุจู ุงูุฃูุฑููู (ุจุฃูู)', 'ุจู ูุตุฑ (ูู ุฃูู ุงูุณุทุฑ)'], a: 1 },
        { section: 'Expr', q: '(ูููุฉ ุงูุชุชุงุญูุฉ ููุฏูุฉ). ุงูุนูุตุฑ ุงูุฐู ูุง ุบูู ุนูู:', options: ['ูุตู ุงูููุงุจุณ', 'ุงูุชุฑุญูุจ ุจุงูุญุถูุฑ ูุงูุชุนุฑูู ุจููุถูุน ุงููุฏูุฉ', 'ุฐูุฑ ุชูุงุตูู ุงูุทุนุงู', 'ุงูุฎุงุชูุฉ'], a: 1 },
        { section: 'Expr', q: '(ูุญู ... ุงููุตุฑููู ... ูุญุจ ุงููุทู). ููุน ุงูุฃุณููุจ:', options: ['ูุฏุงุก', 'ุงุฎุชุตุงุต', 'ุชุนุฌุจ', 'ูุฏุญ'], a: 1 },
        { section: 'Expr', q: 'ุงูููุฒุฉ ูู (ูุณุงุกู) ูุง ููุชุจ ุจุนุฏูุง ุฃูู ูุฃู:', options: ['ูุจููุง ุฃูู ูุฏ', 'ูุจููุง ูุงู', 'ูู ูุชุทุฑูุฉ', 'ููุตูุจุฉ'], a: 0 },
        { section: 'Expr', q: '(ุญุจุฐุง ุงูุตุฏู). ุงููุฎุตูุต ุจุงููุฏุญ:', options: ['ุฐุง', 'ุงูุตุฏู', 'ุญุจ', 'ูุญุฐูู'], a: 1 },
        { section: 'Expr', q: '(ุฅุนุงุฏุฉ ุงูุชุฏููุฑ). ุงูููุฑุฉ ุงูุฏุงุนูุฉ:', options: ['ุญุฑู ุงูููุงูุงุช ูููุซ ุงูุจูุฆุฉ', 'ุชุญููู ุงููุฎููุงุช ุฅูู ููุชุฌุงุช ุฌุฏูุฏุฉ ูููุฑ ุงูุทุงูุฉ ูุงูููุงุฑุฏ', 'ุฅููุงุก ุงูููุงูุฉ ูู ุงูุดุงุฑุน', 'ุดุฑุงุก ููุชุฌุงุช ุฌุฏูุฏุฉ'], a: 1 },
        { section: 'Expr', q: 'ุนูุงูุฉ ุงูุชุฑููู ุจูู ุงูุฌูู ุงููุชุนุงุทูุฉ:', options: ['ุงูููุทุฉ', 'ุงููุงุตูุฉ', 'ุงูููุทุชุงู', 'ุนูุงูุฉ ุงูุงุณุชููุงู'], a: 1 },
        { section: 'Expr', q: '(ูุณุนู ุงููุฌุชูุฏ ... ุงูุชููู). ุญุฑู ุงูุฌุฑ ุงูููุงุณุจ:', options: ['ุฅูู', 'ุนูู', 'ูู', 'ุนู'], a: 0 },
        { section: 'Expr', q: 'ุงููููุฉ ุงููุฎุงููุฉ ููููุงุณ ุงูุตุฑูู ูู ุงูุฌูุน:', options: ['ูุฏุฑุงุก (ุงูุตูุงุจ: ูุฏูุฑูู)', 'ูุนูููู', 'ูููุฏุณูู', 'ุญุฏุงุฆู'], a: 0 },
        { section: 'Expr', q: 'ุงูุฌููุฉ ุงูุฎุงููุฉ ูู ุงูุฃุฎุทุงุก:', options: ['ุฅู ุนูุฑ ุงุจู ุงูุฎุทุงุจ ุนุงุฏู', 'ุฅู ุนูุฑ ุจู ุงูุฎุทุงุจ ุนุงุฏู', 'ุฅู ุนูุฑู ุจู ุงูุฎุทุงุจ ุนุงุฏู'], a: 1 },
        { section: 'Expr', q: 'ุฃูุณุจ ุนููุงู ูููุฑุฉ ุชุชุญุฏุซ ุนู "ุฃุถุฑุงุฑ ุงูุชุฏุฎูู":', options: ['ุงูุชุฏุฎูู ูุงูุฑูุงุถุฉ', 'ุงูุชุญุงุฑ ุจุทูุก', 'ุฒุฑุงุนุฉ ุงูุชุจุบ', 'ุงููุฏุฎู ุงูุฐูู'], a: 1 },
        { section: 'Expr', q: 'ุฎุงุชูุฉ ุงูููุงู ูุฌุจ ุฃู ุชููู:', options: ['ุจุฏุงูุฉ ูููุถูุน ุฌุฏูุฏ', 'ุชูุฎูุตุงู ูุฃูู ุงูุฃููุงุฑ ููุชูุฌุฉ ุญุงุณูุฉ', 'ุฃุทูู ูู ุงูุนุฑุถ', 'ูููุฆุฉ ุจุงูุฃุณุฆูุฉ'], a: 1 },
        { section: 'Expr', q: '(ุดุฎุต ูุทูุจ ุงููุณุชุญูู). ุงููุซู ุงูููุงุณุจ:', options: ['ูุทูุจ ูุจู ุงูุนุตููุฑ', 'ูุถุฑุจ ูู ุญุฏูุฏ ุจุงุฑุฏ', 'ูุญุฑุซ ูู ุงูุจุญุฑ', 'ูู ูุง ุณุจู'], a: 3 },
    ];

    // --- System Variables ---
    const socket = io();
    let studentId = '';
    let deviceId = '';
    let mediaRecorder;
    let violationCount = 0;
    const MAX_VIOLATIONS = 3;
    let isExamStarted = false;
    let userAnswers = new Array(examData.filter(d => d.type !== 'passage').length).fill(null);
    let flaggedQuestions = new Set();
    let eliminatedOptions = {};
    let fontSize = 16;
    let timerDuration = 3 * 3600;
    let timerInterval;
    let isSubmitted = false;

    // --- Init ---
    window.onload = function() {
        // โ ุญุธุฑ ูุถุน ุงููุนุงููุฉ ุชูุงูุงู
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('preview') === 'true') {
            alert('โ ูุถุน ุงููุนุงููุฉ ูุญุธูุฑ! ุณูุชู ุฅุนุงุฏุฉ ุงูุชูุฌูู.');
            window.location.href = '/';
        }

        if(window.innerWidth <= 768) {
            document.getElementById('mobileTools').style.display = 'flex';
        }
        loadProgress();
        renderNav();
        renderQuestions();
    };

    // ุฅูุดุงุก Device Fingerprint
    function generateDeviceId() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = "top";
        ctx.font = "14px 'Arial'";
        ctx.fillText("browser,fingerprint", 2, 2);
        const fingerprint = navigator.userAgent + navigator.language + screen.colorDepth + screen.width + 'x' + screen.height + new Date().getTimezoneOffset() + canvas.toDataURL();
        let hash = 0;
        for (let i = 0; i < fingerprint.length; i++) {
            const char = fingerprint.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return 'DEVICE_' + Math.abs(hash).toString(36).toUpperCase();
    }

    async function initExamSystem() {
        const nameInput = document.getElementById('studentName').value;
        if(nameInput.length < 5) { alert('ุงูุฑุฌุงุก ูุชุงุจุฉ ุงูุงุณู ุงูุซูุงุซู'); return; }
        
        studentId = nameInput.replace(/\s/g, '_') + '_' + Date.now();
        deviceId = generateDeviceId();
        console.log('๐ Device ID:', deviceId);
        
        try {
            // ูุดู ุงููุงููุฑุงุช ุงูุงูุชุฑุงุถูุฉ
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cameras = devices.filter(d => d.kind === 'videoinput');
            const suspiciousNames = ['obs', 'virtual', 'snap', 'manycam', 'xsplit', 'e2e'];
            const hasFakeCamera = cameras.some(cam => suspiciousNames.some(sus => cam.label.toLowerCase().includes(sus)));
            if(hasFakeCamera) {
                alert('โ๏ธ ุชู ุงูุชุดุงู ูุงููุฑุง ุงูุชุฑุงุถูุฉ! ูุฌุจ ุงุณุชุฎุฏุงู ูุงููุฑุง ุญููููุฉ.');
                throw new Error('Virtual camera detected');
            }

            // 1. ุทูุจ ููุก ุงูุดุงุดุฉ
            await document.documentElement.requestFullscreen();
            
            // 2. ุทูุจ ุงููุงููุฑุง
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('userVideo').srcObject = stream;
            document.getElementById('cameraPreview').style.display = 'block';
            
            // 3. ุจุฏุก ุงูุจุซ ุงููุฒุฏูุฌ
            await startDualStream(stream);
            
            // 4. ุชูุนูู ุงูุญูุงูุฉ
            activateProtection();
            
            // 5. ุฅุธูุงุฑ ุงูุงูุชุญุงู
            document.getElementById('startModalOverlay').style.display = 'none';
            document.getElementById('renderArea').style.filter = 'none';
            document.getElementById('renderArea').style.pointerEvents = 'auto';
            isExamStarted = true;
            
            renderNav();
            renderQuestions();
            startTimer();
            updateUI();
            
        } catch (err) {
            alert('โ๏ธ ุฎุทุฃ: ูุฌุจ ุงูุณูุงุญ ูููุงููุฑุง ูููุก ุงูุดุงุดุฉ ูุจุฏุก ุงูุงูุชุญุงู!\n' + err.message);
        }
    }

    // --- Live Stream Logic ---
    function startDualStream(stream) {
        socket.emit('start-stream', { studentId: studentId, deviceId: deviceId });

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('userVideo');
        
        setInterval(() => {
            if(!isExamStarted || isSubmitted) return;
            canvas.width = 320; 
            canvas.height = 240;
            ctx.drawImage(video, 0, 0, 320, 240);
            
            // Watermark
            ctx.font = 'bold 12px Arial';
            ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
            ctx.fillText(`๐ด ${studentId}`, 10, 20);
            ctx.fillText(new Date().toLocaleTimeString('ar-EG'), 10, 40);

            const imageData = canvas.toDataURL('image/jpeg', 0.4);
            socket.emit('live-frame', imageData);
        }, 500);

        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8', videoBitsPerSecond: 1500000 });
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0 && isExamStarted) {
                socket.emit('video-chunk', event.data);
            }
        };
        mediaRecorder.start(1000); 
    }

    // --- Anti-Cheat (ูุดุฏุฏ) ---
    function activateProtection() {
        // 1. ุงูุฎุฑูุฌ ูู ููุก ุงูุดุงุดุฉ
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && isExamStarted && !isSubmitted) {
                recordViolation("ุงูุฎุฑูุฌ ูู ูุถุน ููุก ุงูุดุงุดุฉ");
                setTimeout(() => document.documentElement.requestFullscreen().catch(()=>{}), 1000);
            }
        });

        // 2. ุชุจุฏูู ุงููุงูุฐุฉ
        window.addEventListener('blur', () => {
            if (isExamStarted && !isSubmitted) {
                recordViolation("ุชุจุฏูู ุงููุงูุฐุฉ / ุงูุฎุฑูุฌ ูู ุงูุตูุญุฉ");
                captureEvidence(); 
            }
        });

        // 3. ููุน ุฃุฏูุงุช ุงููุทูุฑูู ูุงูุฒุฑ ุงูุฃููู
        document.addEventListener('contextmenu', (e) => { e.preventDefault(); recordViolation("ูุญุงููุฉ ุงุณุชุฎุฏุงู ุงูุฒุฑ ุงูุฃููู"); });
        
        document.addEventListener('keydown', (e) => {
            if (!isExamStarted) return;
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
                recordViolation("ูุญุงููุฉ ูุชุญ ุฃุฏูุงุช ุงููุทูุฑูู");
            }
            if(e.key === 'PrintScreen') {
                recordViolation("ูุญุงููุฉ ุฃุฎุฐ ููุทุฉ ุดุงุดุฉ");
                navigator.clipboard.writeText(''); // ุฅูุฑุงุบ ุงูุญุงูุธุฉ
            }
        });

        // 4. ูุดู DevTools ุงููุชูุฏู
        (function() {
            let devtoolsOpen = false;
            const threshold = 160;
            setInterval(() => {
                if(window.outerWidth - window.innerWidth > threshold || window.outerHeight - window.innerHeight > threshold) {
                    if(!devtoolsOpen) {
                        devtoolsOpen = true;
                        recordViolation("ูุชุญ ุฃุฏูุงุช ุงููุทูุฑูู (DevTools)");
                    }
                } else {
                    devtoolsOpen = false;
                }
            }, 500);
            // Debugger Trap
            setInterval(() => {
                const start = performance.now();
                debugger;
                const end = performance.now();
                if(end - start > 100) recordViolation("ูุญุงููุฉ ุงุณุชุฎุฏุงู Debugger");
            }, 1000);
        })();

        // 5. ูุดู ุงูุดุงุดุงุช ุงููุชุนุฏุฏุฉ
        if(window.screen.isExtended || screen.availWidth > window.screen.width) {
            recordViolation("ุงุณุชุฎุฏุงู ุฃูุซุฑ ูู ุดุงุดุฉ");
        }
    }

    function recordViolation(reason) {
        if (!isExamStarted || isSubmitted) return;
        
        violationCount++;
        document.getElementById('violationCount').innerText = violationCount;
        
        // ุฅุฑุณุงู ุชูุจูู ููุณูุฑูุฑ (ูู ุงูุฐู ููุฑุฑ ุงูุญุธุฑ)
        socket.emit('violation-alert', {
            reason: reason,
            count: violationCount,
            timestamp: new Date().toISOString(),
            deviceId: deviceId
        });
        
        const div = document.createElement('div');
        div.className = 'toast';
        div.innerText = `โ๏ธ ูุฎุงููุฉ ูุณุฌูุฉ: ${reason}`;
        document.body.appendChild(div);
        setTimeout(()=>div.remove(), 3000);
    }

    function captureEvidence() {
        const video = document.getElementById('userVideo');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        canvas.toBlob(blob => {
            const fd = new FormData();
            fd.append('photo', blob, 'violation.jpg');
            fd.append('studentId', studentId);
            fetch('/api/upload-photo', { method: 'POST', body: fd }).catch(()=>{});
        });
    }

    // --- Rendering Logic ---
    function renderNav() {
        const container = document.getElementById('navContainer');
        container.innerHTML = sectionsConfig.map(sec => `
            <div class="nav-btn" id="nav-${sec.id}" onclick="scrollToSection('${sec.id}')">
                <span>${sec.title}</span>
                <span style="background:var(--border); padding:2px 8px; border-radius:4px; font-size:0.75rem;">${sec.count}</span>
            </div>
        `).join('');
    }

    function renderQuestions() {
        const container = document.getElementById('renderArea');
        let html = '';
        let qCounter = 0;
        
        sectionsConfig.forEach(sec => {
            const items = examData.filter(d => d.section === sec.id);
            if(items.length === 0) return;
            
            html += `<div id="${sec.id}" class="section-header"><h2 style="margin:0; color:var(--primary);">${sec.title}</h2></div>`;
            
            items.forEach(item => {
                if(item.type === 'passage') {
                    html += `<div class="passage-card">${item.content}</div>`;
                } else {
                    const qIdx = qCounter;
                    let optionsHTML = item.options.map((opt, i) => `
                        <div class="option" id="opt-${qIdx}-${i}" onclick="selectOption(${qIdx}, ${i})">
                            <div class="circle"></div><span style="flex:1;">${opt}</span>
                            <button class="strike-btn" onclick="toggleEliminate(event, ${qIdx}, ${i})" title="ุงุณุชุจุนุงุฏ ุงูุฅุฌุงุจุฉ">๐๏ธโ๐จ๏ธ</button>
                        </div>
                    `).join('');
                    
                    html += `
                        <div class="q-card" id="q-card-${qIdx}">
                            <button class="flag-toggle" onclick="toggleFlag(${qIdx})" id="flag-${qIdx}">๐</button>
                            <div style="display:flex; justify-content:space-between; color:var(--text-light); font-size:0.9rem;">
                                <span>ุณุคุงู ${qIdx + 1}</span><span>ุฏุฑุฌุฉ ูุงุญุฏุฉ</span>
                            </div>
                            <div class="q-text">${item.q}</div><div>${optionsHTML}</div>
                        </div>
                    `;
                    qCounter++;
                }
            });
        });
        container.innerHTML = html;
        restoreUIState();
    }

    function selectOption(qIdx, optIdx) {
        if(isSubmitted || (eliminatedOptions[qIdx] && eliminatedOptions[qIdx].includes(optIdx))) return;
        userAnswers[qIdx] = optIdx;
        saveProgress();
        updateUI();
    }

    function toggleEliminate(e, qIdx, optIdx) {
        e.stopPropagation();
        if(isSubmitted) return;
        if(!eliminatedOptions[qIdx]) eliminatedOptions[qIdx] = [];
        const arr = eliminatedOptions[qIdx];
        if(arr.includes(optIdx)) eliminatedOptions[qIdx] = arr.filter(x => x !== optIdx);
        else arr.push(optIdx);
        saveProgress();
        updateOptionStyle(qIdx, optIdx);
    }

    function toggleFlag(qIdx) {
        const btn = document.getElementById(`flag-${qIdx}`);
        const card = document.getElementById(`q-card-${qIdx}`);
        if(flaggedQuestions.has(qIdx)) {
            flaggedQuestions.delete(qIdx);
            btn.classList.remove('active');
            card.classList.remove('flagged-card');
        } else {
            flaggedQuestions.add(qIdx);
            btn.classList.add('active');
            card.classList.add('flagged-card');
        }
        saveProgress();
        updateSheet();
    }

    function updateUI() {
        const total = userAnswers.length;
        const answered = userAnswers.filter(a => a !== null).length;
        document.getElementById('progressFill').style.width = (answered / total * 100) + '%';
        
        userAnswers.forEach((ans, qIdx) => {
            for(let i=0; i<4; i++) {
                const el = document.getElementById(`opt-${qIdx}-${i}`);
                if(el) {
                    el.classList.remove('selected');
                    if(i === ans) el.classList.add('selected');
                }
            }
            const flagBtn = document.getElementById(`flag-${qIdx}`);
            const card = document.getElementById(`q-card-${qIdx}`);
            if(flagBtn && card) {
                if(flaggedQuestions.has(qIdx)) {
                    flagBtn.classList.add('active');
                    card.classList.add('flagged-card');
                } else {
                    flagBtn.classList.remove('active');
                    card.classList.remove('flagged-card');
                }
            }
        });
        updateSheet();
    }

    function updateOptionStyle(qIdx, optIdx) {
        const el = document.getElementById(`opt-${qIdx}-${optIdx}`);
        if(eliminatedOptions[qIdx] && eliminatedOptions[qIdx].includes(optIdx)) {
            el.classList.add('eliminated');
            if(userAnswers[qIdx] === optIdx) {
                userAnswers[qIdx] = null;
                el.classList.remove('selected');
            }
        } else {
            el.classList.remove('eliminated');
        }
    }

    function restoreUIState() {
        for (const [qIdx, opts] of Object.entries(eliminatedOptions)) {
            opts.forEach(optIdx => updateOptionStyle(parseInt(qIdx), optIdx));
        }
        updateUI();
    }

    function toggleSheet() {
        document.getElementById('sheetModal').classList.toggle('open');
        updateSheet();
    }

    function updateSheet() {
        const grid = document.getElementById('sheetGrid');
        grid.innerHTML = userAnswers.map((ans, idx) => {
            let classes = 'bubble';
            if(ans !== null) classes += ' answered';
            if(flaggedQuestions.has(idx)) classes += ' flagged';
            return `<div class="${classes}" onclick="jumpToQ(${idx})">${idx + 1}</div>`;
        }).join('');
    }

    function jumpToQ(idx) {
        document.getElementById('sheetModal').classList.remove('open');
        const el = document.getElementById(`q-card-${idx}`);
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.style.boxShadow = "0 0 0 4px var(--accent)";
        setTimeout(() => el.style.boxShadow = "none", 1000);
    }

    // --- Secure Local Storage ---
    function generateHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return hash.toString(36);
    }

    function saveProgress() {
        const state = {
            answers: userAnswers,
            flags: Array.from(flaggedQuestions),
            eliminated: eliminatedOptions,
            time: timerDuration,
            hash: generateHash(userAnswers.toString() + timerDuration)
        };
        const encrypted = btoa(JSON.stringify(state));
        localStorage.setItem('examProgress_v3', encrypted);
    }

    function loadProgress() {
        const saved = localStorage.getItem('examProgress_v3');
        if(saved) {
            try {
                const decrypted = JSON.parse(atob(saved));
                const expectedHash = generateHash(decrypted.answers.toString() + decrypted.time);
                
                if(decrypted.hash !== expectedHash) {
                    localStorage.removeItem('examProgress_v3');
                    return;
                }

                if(decrypted.answers.length === userAnswers.length) {
                    userAnswers = decrypted.answers;
                    flaggedQuestions = new Set(decrypted.flags);
                    eliminatedOptions = decrypted.eliminated || {};
                    timerDuration = decrypted.time > 0 ? decrypted.time : 3*3600;
                }
            } catch(e) {}
        }
    }

    function clearProgress() {
        localStorage.removeItem('examProgress_v3');
    }

    function startTimer() {
        const display = document.getElementById('timerDisplay');
        const mobileDisplay = document.getElementById('mobileTimer');
        timerInterval = setInterval(() => {
            timerDuration--;
            saveProgress();
            let h = Math.floor(timerDuration / 3600);
            let m = Math.floor((timerDuration % 3600) / 60);
            let s = timerDuration % 60;
            const text = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            display.innerText = text;
            if(mobileDisplay) mobileDisplay.innerText = text;
            if(timerDuration <= 0) submitExam();
        }, 1000);
    }

    function changeFontSize(d) {
        fontSize += d;
        document.body.style.fontSize = fontSize + 'px';
    }
    
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
    }

    function scrollToSection(id) {
        document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`nav-${id}`).classList.add('active');
    }

    function submitExam(force = false) {
        isSubmitted = true;
        clearInterval(timerInterval);
        clearProgress();
        
        if(mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        if(document.getElementById('userVideo').srcObject) {
            document.getElementById('userVideo').srcObject.getTracks().forEach(track => track.stop());
        }
        document.getElementById('cameraPreview').style.display = 'none';
        
        document.exitFullscreen().catch(()=>{});

        let score = 0;
        let qIdx = 0;
        examData.forEach(item => {
            if(item.type !== 'passage') {
                if(userAnswers[qIdx] === item.a) score++;
                qIdx++;
            }
        });

        fetch('/api/finish', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ studentId, score })
        }).catch(()=>{});

        document.getElementById('scoreNum').innerText = score;
        let msg = "";
        
        if(violationCount >= MAX_VIOLATIONS || force) {
            msg = "<span style='color:red'>โ ุชู ุฅููุงุก ุงูุงูุชุญุงู ุจุณุจุจ ุชุฌุงูุฒ ูุฎุงููุงุช ุงูุบุด!</span>";
        } else {
            if(score >= 70) msg = "ูุณุชูู ูุชููุฒ! ๐";
            else if(score >= 50) msg = "ุฌูุฏุ ูููู ุชุญุชุงุฌ ูููุฑุงุฌุนุฉ.";
            else msg = "ูุฌุจ ุจุฐู ูุฌููุฏ ุฃูุจุฑ.";
        }
        
        document.getElementById('feedback').innerHTML = `<strong>ุงูุชูุฏูุฑ:</strong> ${msg}`;
        document.getElementById('resultModal').style.display = 'flex';
    }

    function startReview() {
        document.getElementById('resultModal').style.display = 'none';
        document.body.classList.add('review-mode');
        
        let qIdx = 0;
        examData.forEach(item => {
            if(item.type !== 'passage') {
                const correctOpt = document.getElementById(`opt-${qIdx}-${item.a}`);
                if(correctOpt) correctOpt.classList.add('correct-ans');
                
                if(userAnswers[qIdx] !== null && userAnswers[qIdx] !== item.a) {
                    const wrongOpt = document.getElementById(`opt-${qIdx}-${userAnswers[qIdx]}`);
                    if(wrongOpt) wrongOpt.classList.add('wrong-ans');
                }
                qIdx++;
            }
        });
        window.scrollTo({top:0, behavior:'smooth'});
    }

    // --- Listeners for Ban Events ---
    socket.on('device-banned', (data) => {
        isSubmitted = true;
        clearInterval(timerInterval);
        if(mediaRecorder) mediaRecorder.stop();
        document.body.innerHTML = `
            <div style="position:fixed; top:0; left:0; width:100%; height:100%; background: #000; color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
                <h1 style="color:red; font-size:3rem;">โ ุฌูุงุฒู ูุญุธูุฑ</h1>
                <p>${data.reason}</p>
            </div>
        `;
    });

    socket.on('exam-terminated', (data) => {
        isSubmitted = true;
        clearInterval(timerInterval);
        if(mediaRecorder) mediaRecorder.stop();
        document.exitFullscreen().catch(()=>{});
        
        document.body.innerHTML = `
            <div style="position:fixed; top:0; left:0; width:100%; height:100%; background: #1f2937; color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
                <h1 style="color:#ef4444; font-size:3rem;">โ ุชู ุฅูุบุงุก ุงูุงูุชุญุงู</h1>
                <p style="font-size:1.5rem;">${data.reason}</p>
                <p>ุชู ุญุธุฑ ูุฐุง ุงูุฌูุงุฒ ููุงุฆูุงู ูู ุฏุฎูู ุงูููุตุฉ.</p>
            </div>
        `;
    });
    
    socket.on('duplicate-session', (msg) => {
        alert('โ ' + msg);
        window.location.reload();
    });
</script>
</body>
</html>
